"use strict";window.nianshouAct={opsUrl:"https://ops-api.beeplaying.com",reqActStatus:"/ops/api/monster/activity-icon/",oriPath:"https://wap.beeplaying.com/publicComponent/nianshou/",webUrl:"https://wap.beeplaying.com/nianshou/",resList:["icon.png","tipbg.png","tiparrow.png","light.png","banboo.png","NianShouIcon.prefab","boomNode.prefab"],firstLoad:1,loadedCnt:0,loadedResFinish:0,_loadError:0,res:{},TIPDIR:{LEFT:-1,MIDDLE:0,RIGHT:1},preTotal:0,loading:0,loaded:0,lockingReq:0,iconNode:null,tipNode:null,iconInfo:{},_initNetData:function(){this.accessToken||(this.accessToken=cc.sys.localStorage.getItem("ACCESS_TOKEN")),this.channelID||(this.channelID=cc.sys.localStorage.getItem("APP_CHANNEL")),this.accessToken||(this.accessToken=""),this.channelID||(this.channelID="100039")},_initActData:function(e){var i=e.totalNum||0,o=this.iconInfo.totalNum||0;this.iconInfo.nextStageDiff="number"==typeof e.nextStageDiff?e.nextStageDiff:0,this.iconInfo.show=e.show||!1,this.iconInfo.unreceivedNum=e.unreceivedNum||0,this.iconInfo.totalNum=i,this.preTotal=o},_saveLocalData:function(e,i){var o=JSON.parse(cc.sys.localStorage.getItem("user_Info")),t=0;o&&(t=Number(o.userId)),cc.sys.localStorage.setItem(e+t,i)},refreshStatus:function(){var e=this;this._updateStatus((function(i){e._initActData(i),e.lockingReq=0,e._updateUI(),e.preTotal<e.iconInfo.totalNum&&e._runBoomBanAni(!0)}),(function(){cc.error("请求年兽 icon 状态失败"),e.lockingReq=0}))},_updateUI:function(){if(this.iconInfo.show)if(this.iconNode&&cc.isValid(this.iconNode))if(this.iconNode.active||(this.iconNode.active=!0),this.iconInfo.unreceivedNum>0)this._updateTip("有新的奖励可领取!"),this._tipScaleAction(!0),this._runIconNodeShakeAni();else if(1==this.iconInfo.totalNum&&0==this.preTotal)this._updateTip("获得爆竹,快来驱赶年兽,击落宝物!"),this._tipScaleAction(!0);else if(this.iconInfo.nextStageDiff>0){var e=this.iconInfo.nextStageDiff>10001?(this.iconInfo.nextStageDiff/1e4).toFixed(1)+"W":this.iconInfo.nextStageDiff;this._updateTip("距离下个鸿运奖励,仅差"+e+"支持"),this._tipScaleAction(!0)}else this.iconInfo.totalNum>1&&this.preTotal<this.iconInfo.totalNum?(this._updateTip("恭喜获得新爆竹."),this._tipScaleAction(!0)):this.firstLoad?(this.firstLoad=0,this._updateTip("打年兽,得大奖!"),this._tipScaleAction(!0)):(this._tipScaleAction(!1),this.resetIconChildNode());else this.show(this.iconInfo);else this.iconNode&&cc.isValid(this.iconNode)&&(this.iconNode.active=!1,this._closeWebView())},resetIconChildNode:function(){this.iconChildNode&&cc.isValid(this.iconChildNode)&&(this.iconChildNode.stopAllActions(),this.iconChildNode.rotation=0)},getGameType:function(){if(window.location){var e=location.href,i=location.origin+"/",o=2;switch(e.replace(i,"").split("/")[0].toLowerCase()){case"billiards":o=2;break;case"crush":o=12;break;case"gofish":o=20;break;case"kingdom2":o=13;break;case"landlord":o=15;break;case"legion":o=4;break;case"square":o=18;break;case"marbles":o=21;break;case"fish":o=10;break;case"bird":o=26;break;case"crush3":o=27;break;default:o=2}return o}return 2},_updateStatus:function(e,i){if(this.lockingReq)cc.error("年兽请求被锁");else if(this.lockingReq=1,this._initNetData(),this.iconInfo&&"number"==typeof this.iconInfo.gameType)this.request(this.opsUrl+this.reqActStatus+this.iconInfo.gameType,e,i);else{var o=this.getGameType();this.request(this.opsUrl+this.reqActStatus+o,e,i)}},show:function(e){if(this.loading||this.loaded)cc.error("年兽 正在加载资源或者已加载完成");else if(cc.isValid(e.parentNode)&&"number"==typeof e.gameType){var i=this;this.iconInfo={parentNode:e.parentNode,pos:e.pos||null,height:e.height||null,dir:e.dir||0,gameType:e.gameType,firecrackerNum:0,remark:"",show:!1,status:0},this._updateStatus((function(e){i._initActData(e),i.preTotal=i.iconInfo.totalNum,i.iconInfo.show?(i.loading=1,i._loadResByList()):i.loading=0,i.lockingReq=0}),(function(){cc.error("请求年兽 icon 状态失败"),i.loading=0,i.lockingReq=0}))}else cc.error("年兽的icon 父节点无效 或者 游戏id没有传入")},_loadResByList:function(){for(var e=this.resList.length,i=this,o="",t="",n=0;n<e;n++){if(o=this.resList[n],this._loadError)return void cc.error("年兽 资源已下载失败");if(i.res[o]){if(i.loadedCnt==e){i._loadResFinish();break}}else cc.loader.load(this.oriPath+o,(function(n,c){if(n)return i._loadResError(),void cc.error("年兽 ".concat(o," 资源下载失败"));c.url?(t=(t=c.url.split("/"))[t.length-1],i.res[t]=c):i.res[c.data.name]=c,i.loadedCnt++,i.loadedCnt==e&&i._loadResFinish()}))}},_loadResError:function(){this._loadError=1,this.loading=0,this.loaded=0,cc.error("res load error")},_loadResFinish:function(){this._createBtnNode(),this._initWebView(),this._updateUI(),this._createBoomBanNode(),this.loading=0,this.loaded=1,this.loadedResFinish=1},_createBtnNode:function(){if(this.iconNode)cc.error("已经创建年兽icon");else if(this.iconNode=cc.instantiate(this.res.NianShouIcon),this.iconNode){this._initUI(),this.iconInfo.parentNode.addChild(this.iconNode),this.iconInfo.pos&&(this.iconNode.position=this.iconInfo.pos),"number"==typeof this.iconInfo.height&&this.iconInfo.height!=this.iconNode.height&&this.iconInfo.height>0&&(this.iconNode.scale=Math.max(this.iconInfo.height/this.iconNode.height,.1)),this.tipNode=this.iconNode.getChildByName("TipLayout"),this.iconChildNode=this.iconNode.getChildByName("icon");var e=this;this.iconNode.addComponent(cc.Class({extends:cc.Component,properties:{},start:function(){}})).onDestroy=function(){e.loaded=0,e._loadError=0,e.loading=0,e.iconNode=null,e.boomBanNode=null,e.webViewNode=null,e._destroyNianshou()}}else cc.error("年兽 icon node 已经存在")},_createBoomBanNode:function(){if(this.boomBanNode)cc.error("年兽 已经创建 boomBanNode");else{var e=cc.instantiate(this.res.boomNode);if(e)cc.find("Canvas")&&(e.active=!1,cc.find("Canvas").addChild(e,1e3,"boomban"),e.getChildByName("light").getComponent(cc.Sprite).spriteFrame=new cc.SpriteFrame(this.res["light.png"]),e.getChildByName("banboo").getComponent(cc.Sprite).spriteFrame=new cc.SpriteFrame(this.res["banboo.png"]),this.boomBanNode=e);else cc.error("年兽 boomBanNode 创建失败")}},_runBoomBanAni:function(e){var i=cc.find("Canvas");if(this.boomBanNode&&this.iconNode&&i){var o=this.boomBanNode.getChildByName("light");if(e){o.runAction(cc.repeatForever(cc.rotateBy(.2,18))),this.boomBanNode.x=0,this.boomBanNode.y=0,this.boomBanNode.active=!0,this.boomBanNode.scale=1.5;var t=this,n=this.iconNode.convertToWorldSpaceAR(cc.v2(0,0)),c=i.convertToNodeSpaceAR(n),s=cc.v2(.5*c.x,.5*c.y),a=[cc.v2(0,0),s,c],r=cc.spawn(cc.bezierTo(.6,a),cc.scaleTo(.6,.1)),h=cc.callFunc((function(){t.boomBanNode.active=!1}));this.boomBanNode.runAction(cc.sequence(cc.delayTime(.3),r,h))}else this.boomBanNode.active=!1}else cc.error("年兽 节点尚未创建 不能播放爆竹动画")},_updateTip:function(e){this.tipNode.getChildByName("tipbg").getChildByName("lbl").getComponent(cc.Label).string=e},_tipScaleAction:function(e){if(this.tipNode.stopAllActions(),e){var i=this;this.tipNode.scaleX=.1,this.tipNode.active=!0,this.tipNode.runAction(cc.sequence(cc.delayTime(.2),cc.callFunc((function(){var e=i.tipNode.getChildByName("tipbg").getChildByName("lbl");e.parent.width=e.width+64,0!=i.iconInfo.dir&&(e.parent.x=.5*-i.iconInfo.dir*(e.width-71))})),cc.scaleTo(.1,1.2,1),cc.scaleTo(.1,1,1),cc.delayTime(5),cc.callFunc((function(){i._tipScaleAction(!1)}))))}else this.tipNode.active=!1,this.tipNode.scaleX=.1},_initUI:function(){var e=this.iconNode.getChildByName("TipLayout"),i=new cc.SpriteFrame(this.res["tipbg.png"]);i.insetTop=10,i.insetBottom=21,i.insetLeft=32,i.insetRight=32,this.iconNode.getChildByName("icon").getComponent(cc.Sprite).spriteFrame=new cc.SpriteFrame(this.res["icon.png"]),e.getChildByName("tipbg").getComponent(cc.Sprite).spriteFrame=i,e.getChildByName("tiparrow").getComponent(cc.Sprite).spriteFrame=new cc.SpriteFrame(this.res["tiparrow.png"])},_loadWebViewFinish:function(){this.iconNode.once("click",this._openWebView,this)},_loadWebViewError:function(){this.iconNode.off("click",this._openWebView,this),cc.error("load nianshou  game error")},_initWebView:function(){if(cc.isValid(this.webViewNode))cc.error("年兽 webViewNode 已创建");else{"undefined"!=typeof _ccsg?_ccsg.WebView._polyfill.enableDiv=!0:cc.WebView.Impl._polyfill.enableDiv=!0;var e=new cc.Node("webViewNode"),i=cc.director.getWinSize().height,o=cc.director.getWinSize().width;cc.director.getScene().getChildByName("Canvas").addChild(e),e.width=o,e.height=i,e.x=1e4,e.y=0,e.addComponent(cc.BlockInputEvents);var t,n,c=e.addComponent(cc.WebView);c.url=this.webUrl+"?token="+this.accessToken+"&channel="+this.channelID+"&time="+String((new Date).getTime()),e.on("loaded",this._loadWebViewFinish,this),e.on("error",this._loadWebViewError,this),c._sgNode?(t=c._sgNode._renderCmd._div,n=c._sgNode._renderCmd._iframe):(t=c._impl._div,n=c._impl._iframe),t.style.overflow="hidden",n&&(n.allowTransparency="true");var s=t.style;s.background="rgba(0,0,0,0.7)",s.position="fixed",s.zIndex="10",this.webViewNode=e}},_openWebView:function(){if(cc.isValid(this.webViewNode)){this.webViewNode.getComponent(cc.WebView).evaluateJS("notifyRefreshUI()"),this._tipScaleAction(!1),this.resetIconChildNode();var e=this;this.webViewNode.stopAllActions(),this.webViewNode.runAction(cc.sequence(cc.moveTo(.2,cc.v2(0,0)),cc.callFunc((function(){e.webViewNode.x=0,e.webViewNode.y=0}))))}else this._initWebView()},_closeWebView:function(){var e=this;cc.isValid(this.webViewNode)&&(this.webViewNode.stopAllActions(),1e4!=this.webViewNode.x&&this.webViewNode.runAction(cc.sequence(cc.moveTo(.2,cc.v2(1e4,0)),cc.callFunc((function(){e.iconNode.once("click",e._openWebView,e),e.webViewNode.x=1e4,e.webViewNode.y=0})))),this.refreshStatus())},_destroyNianshou:function(){cc.isValid(this.webViewNode)&&this.webViewNode.destroy(),cc.isValid(this.iconNode)&&this.iconNode.destroy(),cc.isValid(this.boomBanNode)&&this.boomBanNode.destroy(),this.iconNode=null,this.webViewNode=null,this.boomBanNode=null},_runIconNodeShakeAni:function(){this.resetIconChildNode();var e=cc.sequence(cc.rotateTo(.05,-6),cc.delayTime(.12),cc.rotateTo(.1,6),cc.delayTime(.15),cc.rotateTo(.05,-6),cc.delayTime(.12),cc.rotateTo(.1,0),cc.delayTime(1)),i=cc.repeatForever(e);this.iconChildNode.runAction(i)},request:function(e,i,o){var t=this,n=new XMLHttpRequest;return n.open("POST",e,!0),n.setRequestHeader("Content-Type","application/json"),n.setRequestHeader("Authorization",this.accessToken),n.setRequestHeader("App-Version","1.0.0.1"),n.setRequestHeader("Repeated-Submission",String((new Date).getTime())),n.setRequestHeader("App-Channel",this.channelID),n.timeout=15e3,n.ontimeout=function(){cc.error&&cc.error("连接超时")},n.onerror=function(){cc.error&&cc.error("未连接到网络，请检查您的网络设置")},n.onreadystatechange=function(){if(4!==n.readyState)return t;if(n.status>=200&&n.status<=207)if(n.responseText){var e=JSON.parse(n.responseText);200===e.code?i&&i(e.data):o&&o()}else o&&o();else o&&o()},this.params?n.send(JSON.stringify(this.params)):n.send(),this}},window.closeNianshou=function(){nianshouAct._closeWebView()},window.getPlantInfo=function(){return{accessToken:nianshouAct.accessToken,channelID:nianshouAct.channelID}},window.goToGame=function(e){nianshouAct._destroyNianshou(),0!=e.indexOf("http")?window.location.href="//"+document.domain+e+"?token="+nianshouAct.accessToken+"&channel="+nianshouAct.channelID:window.location.href=e+"?token="+nianshouAct.accessToken+"&channel="+nianshouAct.channelID},window.refreshUserData2Nianshou=function(e){};